#!/bin/bash
#==============================================================
# Function to load the python environment for the Isis package
#--------------------------------------------------------------
# AUTHOR: Miguel Ramos Pernas
# e-mail: miguel.ramos.pernas@cern.ch
#==============================================================

usage="
$(basename "$0") [-h] [-i] [-e execfile] [-l loadfiles] [-p pyflags]

Initialize a ipython session with the provided options and the Isis project loaded. If
ipython is not available, python will be used instead.

 -h  show this help text
 -e  executable file
 -i  run in interactive mode (by default if no executable file is specified)
 -l  files to load
 -p  python flags
"

pyflags=""
while getopts 'ha:e:il:p:' option; do
    case "$option" in
	h) echo "$usage"
	   exit
	   ;;
	a) args=$OPTARG
	   ;;
	e) execfile=$OPTARG
	   ;;
	i) pyflags="$pyflags -i"
	   ;;
	l) loadfiles=$OPTARG
	   ;;
	p) pyflags=$pyflags" $OPTARG"
	   ;;
	:) printf "\nError: missing argument for < -%s >\n" "$OPTARG" >&2
	   echo "$usage" >&2
	   exit 1
	   ;;
	\?) printf "\nError: illegal option: < -%s >\n" "$OPTARG" >&2
	    echo "$usage" >&2
	    exit 1
	    ;;
    esac
done
shift $((OPTIND - 1))


# Define the command to be executed

postsc=""

if [ "$execfile" != "" ]; then
    postsc=$postsc" -e $execfile"
else
    pyflags=" -i $pyflags"
fi

if [ "$loadfiles" != "" ]; then
    postsc=$postsc" -l $loadfiles"
fi

if [ "$args" != "" ]; then
    postsc="$postsc -a $args"
fi


# The script < isispy.py > is located at $ISIS_BIN

cmd="$ISIS_BIN/isispy.py $postsc"


# Checks whether any of ipython or python exists and initializes it with the
# Isis and Root modules. It will prioritize initializing ipython first. If none
# of them are accesible the process is aborted.

if   hash ipython 2>/dev/null; then
    ipython $pyflags -c "%run $cmd"
elif hash python  2>/dev/null; then
    python  $pyflags $cmd
else
    echo "Error: No ipython nor python exist. Aborted."
fi
